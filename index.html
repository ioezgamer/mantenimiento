<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Aplicaci√≥n para gestionar mantenimientos de equipos de c√≥mputo">
    <meta name="keywords" content="mantenimiento, computadoras, gesti√≥n, equipos, t√©cnicos">
    <meta name="author" content="Tu Nombre">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tu-sitio-netlify.netlify.app/">
    <meta property="og:title" content="Gestor de Mantenimientos de Computadoras">
    <meta property="og:description" content="Aplicaci√≥n para gestionar mantenimientos de equipos de c√≥mputo">
    <meta property="og:image" content="https://tu-sitio-netlify.netlify.app/og-image.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tu-sitio-netlify.netlify.app/">
    <meta property="twitter:title" content="Gestor de Mantenimientos de Computadoras">
    <meta property="twitter:description" content="Aplicaci√≥n para gestionar mantenimientos de equipos de c√≥mputo">
    <meta property="twitter:image" content="https://tu-sitio-netlify.netlify.app/og-image.jpg">
    
    <title>Gestor de Mantenimientos de Computadoras</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .table-scroll { max-height: 600px; overflow-y: auto; }
        .table-scroll::-webkit-scrollbar { width: 8px; }
        .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-body-scroll::-webkit-scrollbar { width: 6px; }
        .modal-body-scroll::-webkit-scrollbar-track { background: #f8fafc; }
        .modal-body-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
        .modal-body-scroll::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üñ•Ô∏è Gestor de Mantenimientos</h1>
                    <p class="text-gray-600">Control y seguimiento de mantenimientos de equipos de c√≥mputo</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="setupDatabase()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-colors shadow-md">
                        üîß Configurar BD
                    </button>
                    <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium transition-colors shadow-md">
                        üíæ Exportar Datos
                    </button>
                    <button onclick="importData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-colors shadow-md">
                        üì§ Importar Datos
                    </button>
                    <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors shadow-md">
                        ‚ûï Nuevo Mantenimiento
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <span class="text-blue-600 text-xl">üíª</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Total Equipos</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalEquipos">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-full">
                        <span class="text-green-600 text-xl">‚úÖ</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Mantenimientos</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalMantenimientos">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <span class="text-yellow-600 text-xl">‚è∞</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Pr√≥ximos 7 d√≠as</p>
                        <p class="text-2xl font-bold text-gray-800" id="proximosMantenimientos">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-red-100 p-3 rounded-full">
                        <span class="text-red-600 text-xl">üö®</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Vencidos</p>
                        <p class="text-2xl font-bold text-gray-800" id="mantenimientosVencidos">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por equipo, usuario o programa..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <select id="filterStatus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Todos los estados</option>
                    <option value="vigente">Vigente</option>
                    <option value="proximo">Pr√≥ximo (7 d√≠as)</option>
                    <option value="vencido">Vencido</option>
                </select>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="table-scroll">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">En uso por</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Actual</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√≥ximo Mant.</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notas</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[95vh]">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Nuevo Mantenimiento</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="new-maintenance-form" class="flex-grow overflow-y-auto p-6 modal-body-scroll">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Equipo -->
                    <div class="col-span-1">
                        <label for="equipo" class="block text-sm font-medium text-gray-700 mb-1">Equipo</label>
                        <select id="equipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                            <option value="">Seleccionar equipo...</option>
                            <option value="PC-001">PC-001</option>
                        </select>
                    </div>

                    <!-- En uso por -->
                    <div class="col-span-1">
                        <label for="usuario" class="block text-sm font-medium text-gray-700 mb-1">En uso por</label>
                        <select id="usuario" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                            <option value="">Seleccionar usuario...</option>
                            <option value="Juan P√©rez">Juan P√©rez</option>
                        </select>
                    </div>
                    
                    <!-- Tipo de Mantenimiento -->
                    <div class="col-span-1">
                        <label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Mantenimiento</label>
                        <select id="tipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="Preventivo">Preventivo</option>
                            <option value="Correctivo">Correctivo</option>
                            <option value="Predictivo">Predictivo</option>
                        </select>
                    </div>

                    <!-- Estado -->
                    <div class="col-span-1">
                        <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                        <select id="estado" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                            <option value="">Seleccionar estado...</option>
                            <option value="Completado">Completado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Progreso">En Progreso</option>
                        </select>
                    </div>

                    <!-- Fecha de mantenimiento actual -->
                    <div class="col-span-1">
                        <label for="fechaMantenimiento" class="block text-sm font-medium text-gray-700 mb-1">Fecha de mantenimiento actual</label>
                        <input type="date" id="fechaMantenimiento" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                    </div>

                    <!-- Fecha de pr√≥ximo mantenimiento -->
                    <div class="col-span-1">
                        <label for="fechaProximo" class="block text-sm font-medium text-gray-700 mb-1">Fecha de pr√≥ximo mantenimiento</label>
                        <input type="date" id="fechaProximo" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors bg-gray-50" readonly>
                        <small class="text-xs text-gray-500">Se calcula autom√°ticamente (+4 meses)</small>
                    </div>
                    
                    <!-- Descripci√≥n de tareas -->
                    <div class="col-span-2">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n de tareas</label>
                        <textarea id="descripcion" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Detalla las tareas realizadas..."></textarea>
                    </div>
                    
                    <!-- Notas -->
                    <div class="col-span-2">
                        <label for="notas" class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                        <textarea id="notas" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="A√±ade cualquier observaci√≥n adicional..."></textarea>
                    </div>
                </div>
                 <div class="pt-6 border-t border-gray-200 mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium transition-colors">Cancelar</button>
                    <button type="submit" id="save-maintenance" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors shadow-md">Guardar</button>
                </div>
            </form>
        </div>
    </div>
<script>
        let maintenances = [];
        let editingId = null;
        
        // API URLs para las funciones serverless (Neon DB)
        const API_URL = {
            GET_ALL: '/.netlify/functions/get-maintenances',
            GET_ONE: id => `/.netlify/functions/get-maintenance/${id}`,
            CREATE: '/.netlify/functions/create-maintenance',
            UPDATE: id => `/.netlify/functions/update-maintenance/${id}`,
            DELETE: id => `/.netlify/functions/delete-maintenance/${id}`,
            DELETE_ALL: '/.netlify/functions/delete-all-maintenances',
            SETUP: key => `/.netlify/functions/setup-db?key=${encodeURIComponent(key)}`
        };
        
        // Cargar datos desde la API
        async function loadData() {
            try {
                const response = await fetch(API_URL.GET_ALL);
                if (!response.ok) {
                    throw new Error('Error al cargar los datos');
                }
                const data = await response.json();
                maintenances = data.map(item => ({
                    id: item.id,
                    equipo: item.equipo,
                    usuario: item.usuario,
                    tipo: item.tipo,
                    fechaMantenimiento: item.fechaMantenimiento,
                    descripcion: item.descripcion,
                    estado: item.estado,
                    fechaProximo: item.fechaProximo,
                    notas: item.notas
                }));
                renderTable();
                updateStats();
                populateDropdowns();
            } catch (error) {
                console.error('Error al cargar datos:', error);
                alert('Error al cargar los datos. Por favor, intenta de nuevo m√°s tarde.');
            }
        }
        
        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', loadData);
        
        // Datos de ejemplo para inicializar la base de datos si est√° vac√≠a
        const sampleData = [
            {
                equipo: 'PC-001 Dell OptiPlex',
                usuario: 'Juan P√©rez',
                tipo: 'Preventivo',
                fechaMantenimiento: '2024-01-15',
                descripcion: 'Limpieza interna, actualizaci√≥n de drivers, verificaci√≥n de disco duro',
                estado: 'Completado',
                fechaProximo: '2024-05-15',
                notas: 'Equipo en buen estado general'
            },
            {
                equipo: 'LAPTOP-002 HP ProBook',
                usuario: 'Mar√≠a Gonz√°lez',
                tipo: 'Correctivo',
                fechaMantenimiento: '2024-01-20',
                descripcion: 'Limpieza de ventiladores, optimizaci√≥n de sistema, backup de datos',
                estado: 'Pendiente',
                fechaProximo: '2024-05-20',
                notas: 'Bater√≠a al 85% de capacidad'
            }
        ];

        // Funci√≥n para inicializar la base de datos con datos de ejemplo
        async function initializeDatabase() {
            try {
                // Verificar si hay datos
                const response = await fetch(API_URL.GET_ALL);
                
                // Si hay un error 500, puede que la tabla no exista
                if (response.status === 500) {
                    const setupKey = prompt('Por favor, ingrese la clave de configuraci√≥n para inicializar la base de datos:');
                    if (setupKey) {
                        // Intentar configurar la base de datos
                        const setupResponse = await fetch(API_URL.SETUP(setupKey));
                        if (setupResponse.ok) {
                            alert('Base de datos inicializada correctamente. La aplicaci√≥n se recargar√°.');
                            window.location.reload();
                            return;
                        } else {
                            alert('Error al inicializar la base de datos. Clave incorrecta o problema de conexi√≥n.');
                        }
                    }
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Error al verificar datos');
                }
                
                const data = await response.json();
                
                // Si no hay datos, cargar datos de ejemplo
                if (data.length === 0) {
                    for (const item of sampleData) {
                        await fetch(API_URL.CREATE, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(item)
                        });
                    }
                    
                    // Recargar datos
                    loadData();
                }
            } catch (error) {
                console.error('Error al inicializar la base de datos:', error);
            }
        }
        
        // Intentar inicializar la base de datos despu√©s de cargar
        setTimeout(initializeDatabase, 1500);
        
        // Funci√≥n para configurar la base de datos manualmente
        async function setupDatabase() {
            const setupKey = prompt('Por favor, ingrese la clave de configuraci√≥n para inicializar la base de datos:');
            if (!setupKey) return;
            
            try {
                document.body.style.cursor = 'wait';
                const setupResponse = await fetch(API_URL.SETUP(setupKey));
                
                if (setupResponse.ok) {
                    const result = await setupResponse.json();
                    alert('Base de datos configurada correctamente: ' + result.message);
                    window.location.reload();
                } else {
                    const error = await setupResponse.json();
                    alert('Error al configurar la base de datos: ' + (error.error || 'Clave incorrecta o problema de conexi√≥n'));
                }
            } catch (error) {
                console.error('Error al configurar la base de datos:', error);
                alert('Error al configurar la base de datos: ' + error.message);
            } finally {
                document.body.style.cursor = 'default';
            }
        }

        function getUniqueValues() {
            const equipos = new Set();
            const usuarios = new Set();
            const tipos = new Set(['Preventivo', 'Correctivo', 'Predictivo']);
            const estados = new Set(['Completado', 'Pendiente', 'En Progreso']);
            
            maintenances.forEach(item => {
                if (item.equipo) equipos.add(item.equipo);
                if (item.usuario) usuarios.add(item.usuario);
                if (item.tipo) tipos.add(item.tipo);
                if (item.estado) estados.add(item.estado);
            });
            
            return {
                equipos: [...equipos].sort(),
                usuarios: [...usuarios].sort(),
                tipos: [...tipos].sort(),
                estados: [...estados].sort()
            };
        }

        function populateDropdowns() {
            const uniqueValues = getUniqueValues();
            
            populateSelect('equipo', uniqueValues.equipos);
            populateSelect('usuario', uniqueValues.usuarios);
            populateSelect('tipo', uniqueValues.tipos);
            populateSelect('estado', uniqueValues.estados);
        }

        function populateSelect(selectId, values) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Mantener la opci√≥n por defecto
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
            
            // Restaurar valor seleccionado si exist√≠a
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function calculateNextMaintenanceDate(currentDate) {
            if (!currentDate) return '';
            
            const date = new Date(currentDate + 'T00:00:00'); // Asegurar que se interprete como local
            date.setMonth(date.getMonth() + 4);
            
            return date.toISOString().split('T')[0];
        }

        function setupFormHandlers() {
            // Calcular fecha pr√≥ximo mantenimiento autom√°ticamente
            document.getElementById('fechaMantenimiento').addEventListener('change', function() {
                const nextDate = calculateNextMaintenanceDate(this.value);
                document.getElementById('fechaProximo').value = nextDate;
            });
        }

        function openModal(id = null) {
            editingId = id ? parseInt(id) : null;
            const modal = document.getElementById('modal');
            const form = document.getElementById('new-maintenance-form');
            const title = document.getElementById('modalTitle');
            
            // Actualizar dropdowns con datos actuales
            populateDropdowns();
            
            if (id) {
                const maintenance = maintenances.find(m => m.id === parseInt(id));
                title.textContent = 'Editar Mantenimiento';
                
                // Llenar selects y inputs
                document.getElementById('equipo').value = maintenance.equipo;
                document.getElementById('usuario').value = maintenance.usuario;
                document.getElementById('tipo').value = maintenance.tipo;
                document.getElementById('fechaMantenimiento').value = maintenance.fechaMantenimiento;
                document.getElementById('descripcion').value = maintenance.descripcion;
                document.getElementById('fechaProximo').value = maintenance.fechaProximo;
                document.getElementById('estado').value = maintenance.estado;
                document.getElementById('notas').value = maintenance.notas;
            } else {
                title.textContent = 'Nuevo Mantenimiento';
                form.reset();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fechaMantenimiento').value = today;
                document.getElementById('fechaProximo').value = calculateNextMaintenanceDate(today);
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingId = null;
        }

        async function deleteMaintenance(id) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este registro?')) {
                try {
                    const response = await fetch(API_URL.DELETE(id), {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Error al eliminar el mantenimiento');
                    }
                    
                    // Actualizar la lista local y la UI
                    maintenances = maintenances.filter(m => m.id !== id);
                    renderTable();
                    updateStats();
                    populateDropdowns();
                } catch (error) {
                    console.error('Error al eliminar:', error);
                    alert('Error al eliminar el mantenimiento. Por favor, intenta de nuevo.');
                }
            }
        }

        function getStatusBadge(fechaProximo) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalizar a medianoche
            const nextDate = new Date(fechaProximo + 'T00:00:00');
            const diffTime = nextDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Vencido</span>';
            } else if (diffDays <= 7) {
                return '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Pr√≥ximo</span>';
            } else {
                return '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Vigente</span>';
            }
        }

        function getStatusClass(fechaProximo) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextDate = new Date(fechaProximo + 'T00:00:00');
            const diffTime = nextDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'vencido';
            if (diffDays <= 7) return 'proximo';
            return 'vigente';
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;

            let filteredMaintenances = maintenances.filter(m => {
                const matchesSearch = (m.equipo || '').toLowerCase().includes(searchTerm) ||
                                    (m.usuario || '').toLowerCase().includes(searchTerm) ||
                                    (m.tipo || '').toLowerCase().includes(searchTerm) ||
                                    (m.descripcion || '').toLowerCase().includes(searchTerm);
                
                const status = getStatusClass(m.fechaProximo);
                const matchesStatus = !statusFilter || status === statusFilter;

                return matchesSearch && matchesStatus;
            });

            tbody.innerHTML = filteredMaintenances.map((m, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.equipo}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.usuario}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.tipo}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${new Date(m.fechaMantenimiento + 'T00:00:00').toLocaleDateString('es-ES')}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 max-w-xs truncate" title="${m.descripcion}">${m.descripcion}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex flex-col">
                            <span class="text-gray-900">${new Date(m.fechaProximo + 'T00:00:00').toLocaleDateString('es-ES')}</span>
                            ${getStatusBadge(m.fechaProximo)}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.estado}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 max-w-xs truncate" title="${m.notas}">${m.notas}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="openModal('${m.id}')" class="text-blue-600 hover:text-blue-800 font-medium px-2 py-1 rounded hover:bg-blue-50 transition-colors" title="Editar">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteMaintenance('${m.id}')" class="text-red-600 hover:text-red-800 font-medium px-2 py-1 rounded hover:bg-red-50 transition-colors" title="Eliminar">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            document.getElementById('totalEquipos').textContent = maintenances.length;
            document.getElementById('totalMantenimientos').textContent = maintenances.length;
            
            const proximos = maintenances.filter(m => {
                const nextDate = new Date(m.fechaProximo + 'T00:00:00');
                const diffTime = nextDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 7;
            }).length;
            
            const vencidos = maintenances.filter(m => {
                const nextDate = new Date(m.fechaProximo + 'T00:00:00');
                return nextDate < today;
            }).length;
            
            document.getElementById('proximosMantenimientos').textContent = proximos;
            document.getElementById('mantenimientosVencidos').textContent = vencidos;
        }

        // Event Listeners
        document.getElementById('new-maintenance-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                equipo: document.getElementById('equipo').value,
                usuario: document.getElementById('usuario').value,
                tipo: document.getElementById('tipo').value,
                fechaMantenimiento: document.getElementById('fechaMantenimiento').value,
                descripcion: document.getElementById('descripcion').value,
                fechaProximo: document.getElementById('fechaProximo').value,
                estado: document.getElementById('estado').value,
                notas: document.getElementById('notas').value
            };

            // Validar campos requeridos
            if (!formData.equipo || !formData.usuario || !formData.tipo || !formData.estado || !formData.fechaMantenimiento || !formData.fechaProximo) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }

            try {
                let response;
                
                if (editingId) {
                    // Actualizar mantenimiento existente
                    response = await fetch(API_URL.UPDATE(editingId), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Crear nuevo mantenimiento
                    response = await fetch(API_URL.CREATE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al guardar el mantenimiento');
                }
                
                // Recargar datos desde la API
                await loadData();
                closeModal();
            } catch (error) {
                console.error('Error al guardar:', error);
                alert('Error al guardar el mantenimiento: ' + error.message);
            }
        });

        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('filterStatus').addEventListener('change', renderTable);

        // Cerrar modal al hacer clic fuera o en el bot√≥n de cancelar
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        async function exportData() {
            try {
                const response = await fetch(API_URL.GET_ALL);
                if (!response.ok) {
                    throw new Error('Error al obtener datos para exportar');
                }
                
                const data = await response.json();
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'mantenimientos-backup-' + new Date().toISOString().split('T')[0] + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            } catch (error) {
                console.error('Error al exportar datos:', error);
                alert('Error al exportar los datos. Por favor, intenta de nuevo.');
            }
        }
        
        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (Array.isArray(importedData) && importedData.length > 0) {
                            if (confirm(`¬øEst√°s seguro de importar ${importedData.length} registros? Esto reemplazar√° todos los datos actuales.`)) {
                                document.body.style.cursor = 'wait';
                                
                                try {
                                    const setupKey = prompt('Ingrese la clave de seguridad para confirmar la eliminaci√≥n de todos los registros:');
                                    if (!setupKey) {
                                        document.body.style.cursor = 'default';
                                        return;
                                    }
                                    
                                    const deleteResponse = await fetch(API_URL.DELETE_ALL, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${setupKey}` }
                                    });
                                    
                                    if (!deleteResponse.ok) {
                                        throw new Error('Error al eliminar datos actuales');
                                    }
                                    
                                    for (const item of importedData) {
                                        const { id, ...dataWithoutId } = item;
                                        await fetch(API_URL.CREATE, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(dataWithoutId)
                                        });
                                    }
                                    
                                    await loadData();
                                    alert('Datos importados correctamente');
                                } catch (error) {
                                    console.error('Error al importar datos:', error);
                                    alert('Error al importar los datos: ' + error.message);
                                } finally {
                                    document.body.style.cursor = 'default';
                                }
                            }
                        } else {
                            alert('El archivo no contiene datos v√°lidos');
                        }
                    } catch (error) {
                        alert('Error al procesar el archivo: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Inicializar manejadores del formulario
        setupFormHandlers();
    </script>
</body>
</html>
