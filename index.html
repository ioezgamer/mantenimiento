<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Aplicaci√≥n para gestionar mantenimientos de equipos de c√≥mputo">
    <meta name="keywords" content="mantenimiento, computadoras, gesti√≥n, equipos, t√©cnicos">
    <meta name="author" content="Tu Nombre">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tu-sitio-netlify.netlify.app/">
    <meta property="og:title" content="Gestor de Mantenimientos de Computadoras">
    <meta property="og:description" content="Aplicaci√≥n para gestionar mantenimientos de equipos de c√≥mputo">
    <meta property="og:image" content="https://tu-sitio-netlify.netlify.app/og-image.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tu-sitio-netlify.netlify.app/">
    <meta property="twitter:title" content="Gestor de Mantenimientos de Computadoras">
    <meta property="twitter:description" content="Aplicaci√≥n para gestionar mantenimientos de equipos de c√≥mputo">
    <meta property="twitter:image" content="https://tu-sitio-netlify.netlify.app/og-image.jpg">
    
    <title>Gestor de Mantenimientos de Computadoras</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .table-scroll { max-height: 600px; overflow-y: auto; }
        .table-scroll::-webkit-scrollbar { width: 8px; }
        .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üñ•Ô∏è Gestor de Mantenimientos</h1>
                    <p class="text-gray-600">Control y seguimiento de mantenimientos de equipos de c√≥mputo</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium transition-colors shadow-md">
                        üíæ Exportar Datos
                    </button>
                    <button onclick="importData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-colors shadow-md">
                        üì§ Importar Datos
                    </button>
                    <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors shadow-md">
                        ‚ûï Nuevo Mantenimiento
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <span class="text-blue-600 text-xl">üíª</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Total Equipos</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalEquipos">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-full">
                        <span class="text-green-600 text-xl">‚úÖ</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Mantenimientos</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalMantenimientos">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <span class="text-yellow-600 text-xl">‚è∞</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Pr√≥ximos 7 d√≠as</p>
                        <p class="text-2xl font-bold text-gray-800" id="proximosMantenimientos">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-red-100 p-3 rounded-full">
                        <span class="text-red-600 text-xl">üö®</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-600 text-sm">Vencidos</p>
                        <p class="text-2xl font-bold text-gray-800" id="mantenimientosVencidos">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por equipo, usuario o programa..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <select id="filterStatus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Todos los estados</option>
                    <option value="vigente">Vigente</option>
                    <option value="proximo">Pr√≥ximo (7 d√≠as)</option>
                    <option value="vencido">Vencido</option>
                </select>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="table-scroll">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">En uso por</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Programa</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Actual</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tareas Realizadas</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√≥ximo Mant.</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Realizado por</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notas</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Nuevo Mantenimiento</h2>
            </div>
            <form id="maintenanceForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipo</label>
                        <div class="relative">
                            <select id="equipoSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">Seleccionar equipo...</option>
                            </select>
                            <input type="text" id="equipoInput" placeholder="O escribir nuevo equipo..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">En uso por</label>
                        <div class="relative">
                            <select id="usuarioSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">Seleccionar usuario...</option>
                            </select>
                            <input type="text" id="usuarioInput" placeholder="O escribir nuevo usuario..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Programa</label>
                        <div class="relative">
                            <select id="programaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">Seleccionar programa...</option>
                            </select>
                            <input type="text" id="programaInput" placeholder="O escribir nuevo programa..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de mantenimiento actual</label>
                        <input type="date" id="fechaActual" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de pr√≥ximo mantenimiento</label>
                        <input type="date" id="fechaProximo" required readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">Se calcula autom√°ticamente (+4 meses)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mantenimiento realizado por</label>
                        <div class="relative">
                            <select id="realizadoPorSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">Seleccionar t√©cnico...</option>
                            </select>
                            <input type="text" id="realizadoPorInput" placeholder="O escribir nuevo t√©cnico..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tareas de mantenimiento realizadas</label>
                    <textarea id="tareas" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Describe las tareas realizadas..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notas</label>
                    <textarea id="notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Notas adicionales..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let maintenances = [];
        let editingId = null;
        
        // API URLs para las funciones serverless
        const API_URL = {
            GET_ALL: '/.netlify/functions/get-maintenances',
            GET_ONE: id => `/.netlify/functions/get-maintenance/${id}`,
            CREATE: '/.netlify/functions/create-maintenance',
            UPDATE: id => `/.netlify/functions/update-maintenance/${id}`,
            DELETE: id => `/.netlify/functions/delete-maintenance/${id}`,
            SETUP: '/.netlify/functions/setup-db'
        };
        
        // Cargar datos desde la API
        async function loadData() {
            try {
                const response = await fetch(API_URL.GET_ALL);
                if (!response.ok) {
                    throw new Error('Error al cargar los datos');
                }
                maintenances = await response.json();
                renderTable();
                updateStats();
                populateDropdowns();
            } catch (error) {
                console.error('Error al cargar datos:', error);
                alert('Error al cargar los datos. Por favor, intenta de nuevo m√°s tarde.');
            }
        }
        
        // Cargar datos al iniciar
        loadData();
        
        // Datos de ejemplo para inicializar la base de datos si est√° vac√≠a
        const sampleData = [
            {
                equipo: 'PC-001 Dell OptiPlex',
                usuario: 'Juan P√©rez',
                programa: 'Contabilidad',
                fechaActual: '2024-01-15',
                tareas: 'Limpieza interna, actualizaci√≥n de drivers, verificaci√≥n de disco duro',
                fechaProximo: '2024-04-15',
                realizadoPor: 'Carlos Rodr√≠guez',
                notas: 'Equipo en buen estado general'
            },
            {
                equipo: 'LAPTOP-002 HP ProBook',
                usuario: 'Mar√≠a Gonz√°lez',
                programa: 'Recursos Humanos',
                fechaActual: '2024-01-20',
                tareas: 'Limpieza de ventiladores, optimizaci√≥n de sistema, backup de datos',
                fechaProximo: '2024-04-20',
                realizadoPor: 'Ana Mart√≠nez',
                notas: 'Bater√≠a al 85% de capacidad'
            }
        ];

        // Funci√≥n para inicializar la base de datos con datos de ejemplo
        async function initializeDatabase() {
            try {
                // Verificar si hay datos
                const response = await fetch(API_URL.GET_ALL);
                if (!response.ok) {
                    throw new Error('Error al verificar datos');
                }
                
                const data = await response.json();
                
                // Si no hay datos, cargar datos de ejemplo
                if (data.length === 0) {
                    for (const item of sampleData) {
                        await fetch(API_URL.CREATE, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(item)
                        });
                    }
                    
                    // Recargar datos
                    loadData();
                }
            } catch (error) {
                console.error('Error al inicializar la base de datos:', error);
            }
        }
        
        // Intentar inicializar la base de datos despu√©s de cargar
        setTimeout(initializeDatabase, 1000);

        function getUniqueValues(field) {
            return [...new Set(maintenances.map(m => m[field]).filter(value => value && value.trim() !== ''))].sort();
        }

        function populateDropdowns() {
            const equipos = getUniqueValues('equipo');
            const usuarios = getUniqueValues('usuario');
            const programas = getUniqueValues('programa');
            const tecnicos = getUniqueValues('realizadoPor');

            populateSelect('equipoSelect', equipos);
            populateSelect('usuarioSelect', usuarios);
            populateSelect('programaSelect', programas);
            populateSelect('realizadoPorSelect', tecnicos);
        }

        function populateSelect(selectId, values) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Mantener la opci√≥n por defecto
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
            
            // Restaurar valor seleccionado si exist√≠a
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function calculateNextMaintenanceDate(currentDate) {
            if (!currentDate) return '';
            
            const date = new Date(currentDate);
            date.setMonth(date.getMonth() + 4);
            
            return date.toISOString().split('T')[0];
        }

        function setupDropdownHandlers() {
            // Manejar selecci√≥n de equipos
            document.getElementById('equipoSelect').addEventListener('change', function() {
                const input = document.getElementById('equipoInput');
                if (this.value) {
                    input.value = this.value;
                    input.style.display = 'none';
                } else {
                    input.style.display = 'block';
                    input.focus();
                }
            });

            // Manejar selecci√≥n de usuarios
            document.getElementById('usuarioSelect').addEventListener('change', function() {
                const input = document.getElementById('usuarioInput');
                if (this.value) {
                    input.value = this.value;
                    input.style.display = 'none';
                } else {
                    input.style.display = 'block';
                    input.focus();
                }
            });

            // Manejar selecci√≥n de programas
            document.getElementById('programaSelect').addEventListener('change', function() {
                const input = document.getElementById('programaInput');
                if (this.value) {
                    input.value = this.value;
                    input.style.display = 'none';
                } else {
                    input.style.display = 'block';
                    input.focus();
                }
            });

            // Manejar selecci√≥n de t√©cnicos
            document.getElementById('realizadoPorSelect').addEventListener('change', function() {
                const input = document.getElementById('realizadoPorInput');
                if (this.value) {
                    input.value = this.value;
                    input.style.display = 'none';
                } else {
                    input.style.display = 'block';
                    input.focus();
                }
            });

            // Mostrar input cuando se hace clic en √©l
            document.getElementById('equipoInput').addEventListener('focus', function() {
                document.getElementById('equipoSelect').value = '';
            });

            document.getElementById('usuarioInput').addEventListener('focus', function() {
                document.getElementById('usuarioSelect').value = '';
            });

            document.getElementById('programaInput').addEventListener('focus', function() {
                document.getElementById('programaSelect').value = '';
            });

            document.getElementById('realizadoPorInput').addEventListener('focus', function() {
                document.getElementById('realizadoPorSelect').value = '';
            });

            // Calcular fecha pr√≥ximo mantenimiento autom√°ticamente
            document.getElementById('fechaActual').addEventListener('change', function() {
                const nextDate = calculateNextMaintenanceDate(this.value);
                document.getElementById('fechaProximo').value = nextDate;
            });
        }

        function openModal(id = null) {
            editingId = id ? parseInt(id) : null;
            const modal = document.getElementById('modal');
            const form = document.getElementById('maintenanceForm');
            const title = document.getElementById('modalTitle');
            
            // Actualizar dropdowns con datos actuales
            populateDropdowns();
            
            if (id) {
                const maintenance = maintenances.find(m => m.id === parseInt(id));
                title.textContent = 'Editar Mantenimiento';
                
                // Llenar selects y inputs
                document.getElementById('equipoSelect').value = maintenance.equipo;
                document.getElementById('equipoInput').value = maintenance.equipo;
                document.getElementById('equipoInput').style.display = maintenance.equipo ? 'none' : 'block';
                
                document.getElementById('usuarioSelect').value = maintenance.usuario;
                document.getElementById('usuarioInput').value = maintenance.usuario;
                document.getElementById('usuarioInput').style.display = maintenance.usuario ? 'none' : 'block';
                
                document.getElementById('programaSelect').value = maintenance.programa;
                document.getElementById('programaInput').value = maintenance.programa;
                document.getElementById('programaInput').style.display = maintenance.programa ? 'none' : 'block';
                
                document.getElementById('realizadoPorSelect').value = maintenance.realizadoPor;
                document.getElementById('realizadoPorInput').value = maintenance.realizadoPor;
                document.getElementById('realizadoPorInput').style.display = maintenance.realizadoPor ? 'none' : 'block';
                
                document.getElementById('fechaActual').value = maintenance.fechaActual;
                document.getElementById('tareas').value = maintenance.tareas;
                document.getElementById('fechaProximo').value = maintenance.fechaProximo;
                document.getElementById('notas').value = maintenance.notas;
            } else {
                title.textContent = 'Nuevo Mantenimiento';
                form.reset();
                
                // Resetear selects e inputs
                document.getElementById('equipoSelect').value = '';
                document.getElementById('usuarioSelect').value = '';
                document.getElementById('programaSelect').value = '';
                document.getElementById('realizadoPorSelect').value = '';
                
                document.getElementById('equipoInput').value = '';
                document.getElementById('usuarioInput').value = '';
                document.getElementById('programaInput').value = '';
                document.getElementById('realizadoPorInput').value = '';
                
                // Mostrar todos los inputs
                document.getElementById('equipoInput').style.display = 'block';
                document.getElementById('usuarioInput').style.display = 'block';
                document.getElementById('programaInput').style.display = 'block';
                document.getElementById('realizadoPorInput').style.display = 'block';
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fechaActual').value = today;
                document.getElementById('fechaProximo').value = calculateNextMaintenanceDate(today);
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingId = null;
        }

        async function deleteMaintenance(id) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este registro?')) {
                try {
                    const response = await fetch(API_URL.DELETE(id), {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Error al eliminar el mantenimiento');
                    }
                    
                    // Actualizar la lista local
                    maintenances = maintenances.filter(m => m.id !== id);
                    renderTable();
                    updateStats();
                    populateDropdowns();
                } catch (error) {
                    console.error('Error al eliminar:', error);
                    alert('Error al eliminar el mantenimiento. Por favor, intenta de nuevo.');
                }
            }
        }

        function getStatusBadge(fechaProximo) {
            const today = new Date();
            const nextDate = new Date(fechaProximo);
            const diffTime = nextDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Vencido</span>';
            } else if (diffDays <= 7) {
                return '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Pr√≥ximo</span>';
            } else {
                return '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Vigente</span>';
            }
        }

        function getStatusClass(fechaProximo) {
            const today = new Date();
            const nextDate = new Date(fechaProximo);
            const diffTime = nextDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'vencido';
            if (diffDays <= 7) return 'proximo';
            return 'vigente';
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;

            let filteredMaintenances = maintenances.filter(m => {
                const matchesSearch = m.equipo.toLowerCase().includes(searchTerm) ||
                                    m.usuario.toLowerCase().includes(searchTerm) ||
                                    m.programa.toLowerCase().includes(searchTerm);
                
                const status = getStatusClass(m.fechaProximo);
                const matchesStatus = !statusFilter || status === statusFilter;

                return matchesSearch && matchesStatus;
            });

            tbody.innerHTML = filteredMaintenances.map((m, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.equipo}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.usuario}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.programa}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${new Date(m.fechaActual).toLocaleDateString('es-ES')}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 max-w-xs truncate" title="${m.tareas}">${m.tareas}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex flex-col">
                            <span class="text-gray-900">${new Date(m.fechaProximo).toLocaleDateString('es-ES')}</span>
                            ${getStatusBadge(m.fechaProximo)}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${m.realizadoPor}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 max-w-xs truncate" title="${m.notas}">${m.notas}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="openModal('${m.id}')" class="text-blue-600 hover:text-blue-800 font-medium px-2 py-1 rounded hover:bg-blue-50 transition-colors" title="Editar">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteMaintenance('${m.id}')" class="text-red-600 hover:text-red-800 font-medium px-2 py-1 rounded hover:bg-red-50 transition-colors" title="Eliminar">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            const today = new Date();
            
            document.getElementById('totalEquipos').textContent = maintenances.length;
            document.getElementById('totalMantenimientos').textContent = maintenances.length;
            
            const proximos = maintenances.filter(m => {
                const nextDate = new Date(m.fechaProximo);
                const diffTime = nextDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 7;
            }).length;
            
            const vencidos = maintenances.filter(m => {
                const nextDate = new Date(m.fechaProximo);
                return nextDate < today;
            }).length;
            
            document.getElementById('proximosMantenimientos').textContent = proximos;
            document.getElementById('mantenimientosVencidos').textContent = vencidos;
        }

        // Event Listeners
        document.getElementById('maintenanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                equipo: document.getElementById('equipoInput').value || document.getElementById('equipoSelect').value,
                usuario: document.getElementById('usuarioInput').value || document.getElementById('usuarioSelect').value,
                programa: document.getElementById('programaInput').value || document.getElementById('programaSelect').value,
                fechaActual: document.getElementById('fechaActual').value,
                tareas: document.getElementById('tareas').value,
                fechaProximo: document.getElementById('fechaProximo').value,
                realizadoPor: document.getElementById('realizadoPorInput').value || document.getElementById('realizadoPorSelect').value,
                notas: document.getElementById('notas').value
            };

            // Validar campos requeridos
            if (!formData.equipo || !formData.usuario || !formData.fechaActual || !formData.fechaProximo || !formData.realizadoPor) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }

            try {
                let response;
                
                if (editingId) {
                    // Actualizar mantenimiento existente
                    response = await fetch(API_URL.UPDATE(editingId), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Crear nuevo mantenimiento
                    response = await fetch(API_URL.CREATE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }
                
                if (!response.ok) {
                    throw new Error('Error al guardar el mantenimiento');
                }
                
                // Recargar datos desde la API
                await loadData();
                closeModal();
            } catch (error) {
                console.error('Error al guardar:', error);
                alert('Error al guardar el mantenimiento. Por favor, intenta de nuevo.');
            }
        });

        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('filterStatus').addEventListener('change', renderTable);

        // Cerrar modal al hacer clic fuera
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        async function exportData() {
            try {
                // Obtener datos actualizados de la API
                const response = await fetch(API_URL.GET_ALL);
                if (!response.ok) {
                    throw new Error('Error al obtener datos para exportar');
                }
                
                const data = await response.json();
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'mantenimientos-backup-' + new Date().toISOString().split('T')[0] + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            } catch (error) {
                console.error('Error al exportar datos:', error);
                alert('Error al exportar los datos. Por favor, intenta de nuevo.');
            }
        }
        
        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async e => {
                const file = e.target.files[0];
                
                if (!file) {
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = async function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (Array.isArray(importedData) && importedData.length > 0) {
                            if (confirm(`¬øEst√°s seguro de importar ${importedData.length} registros? Esto reemplazar√° todos los datos actuales.`)) {
                                // Mostrar indicador de carga
                                document.body.style.cursor = 'wait';
                                
                                // Eliminar todos los registros existentes y crear los nuevos
                                try {
                                    // Obtener todos los registros actuales
                                    const currentResponse = await fetch(API_URL.GET_ALL);
                                    if (!currentResponse.ok) {
                                        throw new Error('Error al obtener datos actuales');
                                    }
                                    
                                    const currentData = await currentResponse.json();
                                    
                                    // Eliminar todos los registros actuales
                                    for (const item of currentData) {
                                        await fetch(API_URL.DELETE(item.id), {
                                            method: 'DELETE'
                                        });
                                    }
                                    
                                    // Crear los nuevos registros
                                    for (const item of importedData) {
                                        // Eliminar el ID si existe para que la API asigne uno nuevo
                                        const { id, ...dataWithoutId } = item;
                                        
                                        await fetch(API_URL.CREATE, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(dataWithoutId)
                                        });
                                    }
                                    
                                    // Recargar datos
                                    await loadData();
                                    alert('Datos importados correctamente');
                                } catch (error) {
                                    console.error('Error al importar datos:', error);
                                    alert('Error al importar los datos: ' + error.message);
                                } finally {
                                    // Restaurar cursor
                                    document.body.style.cursor = 'default';
                                }
                            }
                        } else {
                            alert('El archivo no contiene datos v√°lidos');
                        }
                    } catch (error) {
                        alert('Error al procesar el archivo: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Inicializar
        populateDropdowns();
        setupDropdownHandlers();
        renderTable();
        updateStats();
    </script>
<!-- Script de Cloudflare eliminado para evitar problemas en Netlify --></body>
</html>
